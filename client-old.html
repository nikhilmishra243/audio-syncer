<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>System Audio Stream</title>
    <style>
        :root{
            --accent1: #00e676;
            --accent2: #00c853;
            --glass: rgba(255,255,255,0.06);
            --glass-2: rgba(255,255,255,0.04);
            --text: #eef6f9;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body {
            margin: 0;
            font-family: "Poppins", Arial, sans-serif;
            background: radial-gradient(1000px 600px at 10% 20%, rgba(0,0,0,0.18), transparent),
                        linear-gradient(135deg,#0f1724 0%,#1f1c2c 35%, #5b4666 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text);
            overflow: hidden;
        }
        .blob{position: absolute;filter: blur(60px);opacity: .45;mix-blend-mode: screen;transform: translate3d(0,0,0);pointer-events: none;}
        .blob.b1{width:520px;height:520px;background:linear-gradient(45deg,#8c6cff,#00e5ff); left:-10%; top:-15%;}
        .blob.b2{width:420px;height:420px;background:linear-gradient(45deg,#00e676,#00c853); right:-8%; bottom:-20%;}
        .card {width: 92%;max-width: 520px;padding: 30px 28px;text-align: center;backdrop-filter: blur(12px) saturate(120%);background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius: 18px;box-shadow: 0 30px 80px rgba(3,6,23,0.65), inset 0 1px 0 rgba(255,255,255,0.02);animation: fadeIn 0.6s ease;border: 1px solid rgba(255,255,255,0.04);position: relative;z-index: 2;}
        h2 {font-size: 28px;margin: 0 0 10px 0;font-weight: 700;letter-spacing: -0.4px;}
        .sub{font-size:13px;color:rgba(255,255,255,0.7);margin-bottom:18px}
        .info{font-size:12px;color:rgba(255,255,255,0.6);margin-top:14px;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px}
        #playBtn {width: 100%;padding: 16px 20px;font-size: 18px;border: none;border-radius: 999px;cursor: pointer;font-weight: 700;background: linear-gradient(90deg,var(--accent1), var(--accent2));color: #021009;transition: transform .18s ease, box-shadow .18s ease;position: relative;overflow: hidden;box-shadow: 0 8px 28px rgba(2,200,118,0.12), 0 2px 6px rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;gap:12px;}
        #playBtn:active{transform:scale(.98)}
        #playBtn:hover{box-shadow: 0 14px 40px rgba(2,200,118,0.14)}
        #playBtn .icon{width:22px;height:22px;display:inline-block;}
        p { margin-top: 14px; font-size: 15px; opacity: .95 }
        #st{font-weight:700;color:var(--accent1)}
        .wave{margin-top:16px;height:36px;display:flex;gap:6px;align-items:end;justify-content:center;pointer-events:none}
        .bar{width:6px;border-radius:3px;background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.12));opacity:.9;transform-origin:bottom;animation:bar 1s infinite ease-in-out}
        .bar.b2{animation-delay:.08s;height:10px}
        .bar.b3{animation-delay:.16s;height:18px}
        .bar.b4{animation-delay:.24s;height:12px}
        .bar.b5{animation-delay:.32s;height:22px}
        @keyframes bar{0%{transform:scaleY(.35)}50%{transform:scaleY(1.0)}100%{transform:scaleY(.45)}}
        @keyframes fadeIn {from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
        footer{position:fixed;left:0;right:0;bottom:18px;display:flex;justify-content:center;z-index:3}
        .footer-badge{background:var(--glass-2);backdrop-filter:blur(8px);border-radius:999px;padding:8px 14px;border:1px solid rgba(255,255,255,0.03);display:inline-flex;gap:10px;align-items:center;font-size:13px;color:rgba(255,255,255,0.9)}
        .footer-badge a{color:inherit;text-decoration:none;font-weight:700;display:inline-flex;align-items:center;gap:8px}
        .gh{width:18px;height:18px;display:inline-block}
        @media (max-width:420px){ .card{padding:20px;margin:14px} h2{font-size:22px} #playBtn{font-size:16px;padding:14px} }
    </style>
</head>
<body>
<div class="blob b1"></div>
<div class="blob b2"></div>
<div class="card">
    <h2>System Audio Stream</h2>
    <div class="sub">Low-latency streaming â€¢ Click Play to start</div>
    <button id="playBtn">
        <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M5 3v18l15-9L5 3z" fill="#021009" />
        </svg>
        <span>Play Stream</span>
    </button>
    <div class="wave">
        <div class="bar b1" style="height:14px"></div>
        <div class="bar b2"></div>
        <div class="bar b3"></div>
        <div class="bar b4"></div>
        <div class="bar b5"></div>
    </div>
    <p>Status: <span id="st">Idle</span></p>
    <div class="info">ðŸŽµ Click Play and enjoy the stream!</div>
</div>
<footer>
    <div class="footer-badge">
        <span>Powered by</span>
        <a href="https://github.com/nikhilmishra243" target="_blank">
            <svg class="gh" viewBox="0 0 16 16">
                <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2 .37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.13 0 0 .67-.21 2.2.82a7.6 7.6 0 012 0c1.53-1.03 2.2-.82 2.2-.82.44 1.11.16 1.93.08 2.13.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38C13.71 14.53 16 11.54 16 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            <span>Nikhil Mishra</span>
        </a>
    </div>
</footer>
<script>
    let st = document.getElementById("st");
    let ctx, ws, queue = [], playTime = 0;

    document.getElementById("playBtn").onclick = async () => {
        st.innerText = "Connecting...";
        st.style.color = "#ff9800";

        // Create and RESUME AudioContext (CRITICAL!)
        ctx = new AudioContext({sampleRate: 44100, latencyHint: 'interactive'});

        // MUST resume - browsers suspend by default!
        if (ctx.state === 'suspended') {
            await ctx.resume();
        }

        console.log("AudioContext state:", ctx.state);

        ws = new WebSocket("ws://" + location.hostname + ":9000");
        ws.binaryType = "arraybuffer";

        ws.onopen = () => {
            st.innerText = "Connected";
            st.style.color = "#00e676";
            console.log("WebSocket connected, AudioContext:", ctx.state);
        };

        ws.onmessage = (e) => {
            queue.push(new Int16Array(e.data));
            if (st.innerText !== "Streaming") {
                st.innerText = "Streaming";
                st.style.color = "#00e676";
            }
        };

        ws.onerror = () => {
            st.innerText = "Error";
            st.style.color = "#ff5252";
        };

        ws.onclose = () => {
            st.innerText = "Disconnected";
            st.style.color = "#ff9800";
        };

        function play() {
            const now = ctx.currentTime;
            if (playTime < now) playTime = now + 0.05;

            let processed = 0;
            while (queue.length > 0 && processed < 4) {
                let pcm = queue.shift();
                let frames = pcm.length / 2;
                let buf = ctx.createBuffer(2, frames, 44100);
                let L = buf.getChannelData(0);
                let R = buf.getChannelData(1);

                for (let i = 0, j = 0; j < frames; j++) {
                    L[j] = pcm[i++] / 32768.0;
                    R[j] = pcm[i++] / 32768.0;
                }

                let src = ctx.createBufferSource();
                src.buffer = buf;
                src.connect(ctx.destination);
                src.start(playTime);
                playTime += buf.duration;
                processed++;
            }

            if (queue.length > 50) {
                queue.splice(0, Math.floor(queue.length / 3));
            }

            requestAnimationFrame(play);
        }

        play();
    };
</script>
</body>
</html>